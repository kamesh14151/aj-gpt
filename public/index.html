<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AJ-GPT</title>
<!-- Favicon: Yellow circle with a black 'B' -->
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAgVBMVEUAAAD/ZADPfgD+/wD//wD/ZADSgQD/ZADOgwD/NAD///+Xk5OVlZVMS0tGRkZKSkpDQ0MAAAD/YwD+fgD7/wD/bQDQgQD/cQD/gwD0/wD/jwDPjgDPjwD/lwD//wD///+Xl5eUlJShoaGkpKSBgYF/f39+fn56enp2dnYmJiasx30PAAAAKXRFWHRDcmVhdGlvbiBUaW1lAGAQNyAyMiAwMDoxMzoyMSAyMDI0C5p58AAAAEJJREFUGNONzNccgDAIQFE2x5RjHrv/S22KxP1C4v4eCkgM4l+F+l/QdD+qB8fQoKk/X+p/81/25yR2c+T/H/ZzQh+pXk8b6gV0wAAAAAElFTkSuQmCC">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<style>
:root {
  --primary: #6366f1;
  --secondary: #8b5cf6;
  --accent: #ec4899;
  --aj-yellow: #FFD700;
  --flash-color: #4F46E5;
  --mini-color: #9333EA;
  --claude-color: #d946ef;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --border: #334155;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --shadow: rgba(0, 0, 0, 0.25);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --code-bg: #1e293b;
  --code-border: #334155;
  --hover: rgba(255, 255, 255, 0.05);
  
  /* Light theme variables */
  --bg-primary-light: #ffffff;
  --bg-secondary-light: #f8fafc;
  --bg-tertiary-light: #f1f5f9;
  --text-primary-light: #0f172a;
  --text-secondary-light: #64748b;
  --border-light: #e2e8f0;
  --code-bg-light: #f8fafc;
  --code-border-light: #e2e8f0;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
  transition: background-color 0.3s ease, color 0.3s ease;
}

body.light-theme {
  --bg-primary: var(--bg-primary-light);
  --bg-secondary: var(--bg-secondary-light);
  --bg-tertiary: var(--bg-tertiary-light);
  --text-primary: var(--text-primary-light);
  --text-secondary: var(--text-secondary-light);
  --border: var(--border-light);
  --code-bg: var(--code-bg-light);
  --code-border: var(--code-border-light);
}

/* App Container */
.app-container {
  display: flex;
  height: 100vh;
  width: 100%;
}
/* Sidebar */
.sidebar {
  width: 260px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transition: var(--transition);
  position: relative;
  z-index: 10;
}
.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}
.new-chat-btn {
  width: 100%;
  padding: 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: var(--transition);
}
.new-chat-btn:hover {
  background: var(--hover);
}
.sidebar-search {
  padding: 12px;
}
.search-box {
  position: relative;
}
.search-input {
  width: 100%;
  padding: 8px 12px 8px 36px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 14px;
  transition: var(--transition);
}
.search-input:focus {
  outline: none;
  border-color: var(--primary);
}
.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
}
.chat-history {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
.chat-history-item {
  padding: 10px 12px;
  margin-bottom: 4px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: var(--transition);
}
.chat-history-item:hover {
  background: var(--hover);
}
.chat-history-item.active {
  background: var(--primary);
}
.chat-history-title {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.chat-history-date {
  font-size: 12px;
  color: var(--text-secondary);
}
.sidebar-footer {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: center;
}
.settings-btn {
  width: 100%;
  padding: 10px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: var(--transition);
}
.settings-btn:hover {
  background: var(--hover);
}
/* Main Content */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}
/* Chat Header */
.chat-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--bg-secondary);
  position: relative;
  z-index: 5;
}
.chat-title {
  font-size: 16px;
  font-weight: 500;
  text-align: center;
  flex-grow: 1;
  margin-left: 50px;
}
.ai-status {
  display: flex;
  align-items: center;
  gap: 8px;
  position: absolute;
  left: 24px;
  top: 50%;
  transform: translateY(-50%);
}
.ai-status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--success);
}
.ai-status-indicator.offline {
  background: var(--error);
}
.ai-status-text {
  font-size: 14px;
  color: var(--text-secondary);
}
.chat-actions {
  position: absolute;
  right: 24px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 8px;
  z-index: 1;
}
.icon-btn {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
}
.icon-btn:hover {
  background: var(--hover);
  color: var(--text-primary);
}
/* Chat Container */
.chat-container {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-bottom: 100px; /* Space for input area */
}
.chat-container::-webkit-scrollbar {
  width: 8px;
}
.chat-container::-webkit-scrollbar-track {
  background: transparent;
}
.chat-container::-webkit-scrollbar-thumb {
  background: var(--bg-tertiary);
  border-radius: 4px;
}
.chat-container::-webkit-scrollbar-thumb:hover {
  background: var(--border);
}
/* Welcome Screen */
.welcome-screen {
  max-width: 680px;
  margin: 0 auto;
  text-align: center;
  padding: 40px 0;
}
.welcome-title {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 16px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.welcome-subtitle {
  font-size: 18px;
  color: var(--text-secondary);
  margin-bottom: 32px;
}
.example-prompts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
  margin-top: 32px;
}
.example-prompt {
  padding: 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  text-align: left;
  cursor: pointer;
  transition: var(--transition);
}
.example-prompt:hover {
  background: var(--hover);
  border-color: var(--primary);
}
.example-prompt-title {
  font-weight: 600;
  margin-bottom: 8px;
}
.example-prompt-desc {
  font-size: 14px;
  color: var(--text-secondary);
}
/* Messages */
.message {
  display: flex;
  gap: 16px;
  max-width: 800px;
  margin: 0 auto;
  animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.message.user {
  flex-direction: row-reverse;
}
.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
}
.message.user .message-avatar {
  background: var(--primary);
}
.message.ai.grok .message-avatar {
  background: var(--flash-color);
}
.message.ai.gemini .message-avatar {
  background: var(--mini-color);
}
.message.ai.claude .message-avatar {
  background: var(--claude-color);
}

.message-content {
  flex: 1;
  padding: 16px 20px;
  border-radius: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
}
.message.user .message-content {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}
.message-text {
  font-size: 16px;
  line-height: 1.5;
}
.message-text p {
  margin-bottom: 12px;
}
.message-text p:last-child {
  margin-bottom: 0;
}
.message-text ul, .message-text ol {
  margin-left: 20px;
  margin-bottom: 12px;
}
.message-text a {
  color: var(--primary);
  text-decoration: none;
}
.message-text a:hover {
  text-decoration: underline;
}

/* Enhanced formatting for AI messages */
.message-text h1 {
  font-size: 2em;
  font-weight: 700;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  color: var(--text-primary);
  border-bottom: 2px solid var(--primary);
  padding-bottom: 0.3em;
}

.message-text h2 {
  font-size: 1.5em;
  font-weight: 600;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  color: var(--text-primary);
  border-bottom: 1px solid var(--secondary);
  padding-bottom: 0.2em;
}

.message-text h3 {
  font-size: 1.25em;
  font-weight: 600;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  color: var(--text-primary);
}

.message-text h4, .message-text h5, .message-text h6 {
  font-size: 1.1em;
  font-weight: 600;
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  color: var(--text-primary);
}

.message-text table {
  width: 100%;
  border-collapse: collapse;
  margin: 1em 0;
  background: var(--bg-tertiary);
  border-radius: 8px;
  overflow: hidden;
}

.message-text th, .message-text td {
  border: 1px solid var(--border);
  padding: 0.75em;
  text-align: left;
}

.message-text th {
  background: var(--primary);
  color: white;
  font-weight: 600;
}

.message-text tr:nth-child(even) {
  background: rgba(255, 255, 255, 0.05);
}

.message-text blockquote {
  border-left: 4px solid var(--primary);
  padding-left: 1em;
  margin: 1em 0;
  font-style: italic;
  color: var(--text-secondary);
}

.message-text .highlight {
  background: rgba(99, 102, 241, 0.2);
  padding: 0.2em 0.4em;
  border-radius: 4px;
}

/* Code blocks */
.code-block {
  background: var(--code-bg);
  border: 1px solid var(--code-border);
  border-radius: 8px;
  margin: 12px 0;
  overflow: hidden;
}
.code-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--code-border);
}
.code-language {
  font-size: 12px;
  color: var(--text-secondary);
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 6px;
}
.copy-code-btn, .preview-code-btn {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: var(--transition);
}
.copy-code-btn:hover, .preview-code-btn:hover {
  background: var(--bg-primary);
  color: var(--text-primary);
}
.code-content {
  padding: 12px;
  overflow-x: auto;
  min-height: 60px; /* Ensure minimum height for visibility */
}
.code-content pre {
  margin: 0;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-primary); /* Ensure text color is visible */
}
.message-text code {
  background: var(--bg-primary);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  color: var(--text-primary); /* Ensure inline code is visible */
}

/* Large code blocks */
.code-block.large-code .code-content {
  max-height: 400px;
  overflow-y: auto;
}

.code-block.large-code .code-content::-webkit-scrollbar {
  width: 8px;
}

.code-block.large-code .code-content::-webkit-scrollbar-track {
  background: var(--bg-primary);
}

.code-block.large-code .code-content::-webkit-scrollbar-thumb {
  background: var(--bg-tertiary);
  border-radius: 4px;
}

.code-block.large-code .code-content::-webkit-scrollbar-thumb:hover {
  background: var(--border);
}

/* Code block loading state */
.code-block.loading .code-content {
  position: relative;
}

.code-block.loading .code-content::after {
  content: "Processing code...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: var(--text-secondary);
  font-size: 14px;
}

/* Code Preview Container */
.preview-container {
  margin-top: 10px;
  border: 1px solid var(--code-border);
  border-radius: 8px;
  overflow: hidden;
  display: none;
}
.preview-header {
  background: var(--bg-tertiary);
  padding: 8px 12px;
  font-size: 14px;
  font-weight: 500;
  border-bottom: 1px solid var(--code-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.preview-content {
  padding: 0;
  background: white;
  color: black;
  max-height: 400px;
  overflow: auto;
}

.preview-content iframe {
  width: 100%;
  height: 100%;
  min-height: 200px;
  border: none;
}

.preview-close {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: var(--transition);
}
.preview-close:hover {
  background: var(--bg-primary);
  color: var(--text-primary);
}

.message-actions {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}
.message-action {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
}
.message-action:hover {
  color: var(--text-primary);
}
/* Typing Indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 16px 20px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  width: fit-content;
  max-width: 800px;
  margin: 0 auto;
}
.typing-dots {
  display: flex;
  gap: 4px;
}
.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-secondary);
  animation: typingDot 1.4s infinite;
}
.typing-dot:nth-child(1) {
  animation-delay: 0s;
}
.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}
.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}
@keyframes typingDot {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}
/* Input Area */
.input-area {
  padding: 24px;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 10;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}
.input-container {
  max-width: 800px;
  margin: 0 auto;
  position: relative;
}
.input-field {
  width: 100%;
  padding: 16px 50px 16px 20px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 16px;
  resize: none;
  min-height: 56px;
  max-height: 200px;
  transition: var(--transition);
}
.input-field:focus {
  outline: none;
  border-color: var(--primary);
}
.input-actions {
  position: absolute;
  right: 12px;
  bottom: 12px;
  display: flex;
  gap: 8px;
}
.input-action {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
}
.input-action:hover {
  background: var(--hover);
  color: var(--text-primary);
}
.send-button {
  position: absolute;
  right: 12px;
  bottom: 12px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--primary);
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}
.send-button:hover {
  background: var(--secondary);
}
.send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
/* Mobile Menu Button */
.mobile-menu-btn {
  display: none;
  position: fixed;
  top: 16px;
  left: 16px;
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  color: var(--text-primary);
  z-index: 20;
  cursor: pointer;
  align-items: center;
  justify-content: center;
}

/* Model Selector Modal */
.model-selector-modal {
  display: none;
  position: absolute;
  top: 60px;
  right: 24px;
  width: 280px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 10px 25px var(--shadow);
  z-index: 60;
  overflow: hidden;
  animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.model-modal-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
}
.model-modal-option {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: var(--transition);
}
.model-modal-option:hover {
  background: var(--hover);
}
.model-modal-option.active {
  background: var(--hover);
}
.model-modal-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
}
.model-modal-info {
  flex: 1;
}
.model-modal-name {
  font-weight: 600;
  margin-bottom: 4px;
}
.model-modal-desc {
  font-size: 12px;
  color: var(--text-secondary);
}
.model-status {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
}
.model-status-indicator {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--success);
}
.model-status-indicator.offline {
  background: var(--error);
}
.model-status-text {
  font-size: 11px;
  color: var(--text-secondary);
}
/* Settings Modal */
.settings-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 100;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.settings-content {
  background: var(--bg-secondary);
  border-radius: 16px;
  width: 100%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid var(--border);
}
.settings-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.settings-title {
  font-size: 20px;
  font-weight: 600;
}
.settings-close {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
}
.settings-close:hover {
  background: var(--hover);
  color: var(--text-primary);
}
.settings-body {
  padding: 20px;
}
.settings-section {
  margin-bottom: 24px;
}
.settings-section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}
.settings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.settings-item:last-child {
  border-bottom: none;
}
.settings-label {
  font-size: 14px;
}
.settings-control {
  display: flex;
  align-items: center;
  gap: 12px;
}
.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  background: var(--bg-tertiary);
  border-radius: 24px;
  cursor: pointer;
  transition: var(--transition);
}
.toggle-switch.active {
  background: var(--primary);
}
.toggle-switch-handle {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  transition: var(--transition);
}
.toggle-switch.active .toggle-switch-handle {
  transform: translateX(20px);
}
.settings-select {
  padding: 6px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 14px;
}
.settings-range {
  width: 120px;
}
.settings-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}
.settings-button {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}
.settings-button-primary {
  background: var(--primary);
  color: white;
}
.settings-button-primary:hover {
  background: var(--secondary);
}
.settings-button-secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.settings-button-secondary:hover {
  background: var(--hover);
}
/* Toast Notification */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-tertiary);
  color: var(--text-primary);
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px var(--shadow);
  z-index: 200;
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  max-width: 90%;
}
.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}
.toast.success {
  border-left: 4px solid var(--success);
}
.toast.error {
  border-left: 4px solid var(--error);
}
.toast.info {
  border-left: 4px solid var(--primary);
}
/* Responsive */
@media (max-width: 768px) {
  .mobile-menu-btn {
    display: flex;
  }
  
  .sidebar {
    position: fixed;
    left: -260px;
    height: 100%;
    z-index: 50;
    transition: left 0.3s ease;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 40;
  }
  
  .sidebar-overlay.show {
    display: block;
  }
  
  .chat-header {
    padding: 16px;
  }

  .chat-title {
    margin-left: 0;
    text-align: center;
  }
  .chat-actions {
    right: 16px;
    left: auto;
  }
  
  .ai-status {
    display: none; /* Hide on mobile to save space */
  }

  .chat-container {
    padding: 16px;
    padding-bottom: 120px; /* More space for fixed input area on mobile */
  }
  
  .input-area {
    padding: 16px;
    /* Already fixed at bottom */
  }
  
  .welcome-title {
    font-size: 24px;
  }
  
  .example-prompts {
    grid-template-columns: 1fr;
  }
  
  .model-selector-modal {
    top: 60px;
    right: 16px;
    width: 240px;
  }
  
  .message-content {
    padding: 12px 16px;
    max-width: calc(100% - 48px);
    width: fit-content;
  }
  .message.user .message-content {
      margin-left: auto;
  }
  
  .message-text {
    font-size: 15px;
  }
  
  .code-block {
    margin: 8px 0;
  }
  
  .code-content {
    padding: 8px;
    font-size: 13px;
    min-height: 50px; /* Ensure minimum height on mobile */
  }
  
  .input-field {
    padding: 14px 50px 14px 16px;
    font-size: 15px;
  }
  
  .input-action, .send-button {
    width: 28px;
    height: 28px;
  }
  
  .message-avatar {
    width: 28px;
    height: 28px;
  }
  
  .icon-btn {
    width: 28px;
    height: 28px;
  }
  
  .chat-history-item {
    padding: 8px 10px;
  }
  
  .welcome-screen {
    padding: 30px 0;
  }
  
  .example-prompt {
    padding: 12px;
  }
  
  .settings-content {
    max-height: 90vh;
  }
  
  .toast {
    bottom: 80px;
    padding: 10px 16px;
    font-size: 14px;
    max-width: calc(100% - 32px);
  }

  .code-content pre code {
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  /* Mobile preview container adjustments */
  .preview-container {
    margin: 8px 0;
  }
  
  .preview-content {
    max-height: 250px;
    padding: 12px;
  }
  
  /* Mobile message text adjustments */
  .message-text h1 {
    font-size: 1.6em;
  }
  
  .message-text h2 {
    font-size: 1.3em;
  }
  
  .message-text h3 {
    font-size: 1.1em;
  }
  
  .message-text table {
    font-size: 14px;
  }
  
  .message-text th, .message-text td {
    padding: 0.5em;
  }
}
</style>
</head>
<body>
<div class="app-container">
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="fas fa-bars"></i>
  </button>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="new-chat-btn" id="newChatBtn">
        <i class="fas fa-plus"></i> New chat
      </button>
    </div>
    
    <div class="sidebar-search">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="searchInput" placeholder="Search chat history...">
      </div>
    </div>
    
    <div class="chat-history" id="chatHistory">
      <!-- Chat history items will be dynamically loaded here -->
    </div>
    
    <div class="sidebar-footer">
      <button class="settings-btn" id="settingsBtn">
        <i class="fas fa-cog"></i> Settings
      </button>
    </div>
  </div>
  
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- Main Content -->
  <div class="main-content">
    <!-- Chat Header -->
    <div class="chat-header">
      <div class="ai-status" id="aiStatus">
        <span class="ai-status-indicator" id="aiStatusIndicator"></span>
        <span class="ai-status-text" id="aiStatusText">AJ-GPT-flash</span>
      </div>
      <div class="chat-title">AJ-GPT</div>
      
      <div class="chat-actions">
        <!-- New button for model selection -->
        <div class="icon-btn" title="Select AI Model" id="modelSelectBtnInHeader">
            <i class="fas fa-robot"></i>
        </div>
        <div class="icon-btn" title="Export Chat">
          <i class="fas fa-download"></i>
        </div>
        <div class="icon-btn" title="Clear Chat" id="clearChatBtn">
          <i class="fas fa-trash"></i>
        </div>
      </div>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
      <!-- Welcome Screen (shown when chatHistoryData is empty) -->
      <div class="welcome-screen" id="welcomeScreen">
        <h1 class="welcome-title">AJ-GPT</h1>
        <p class="welcome-subtitle">How can I help you today?</p>
        
        <div class="example-prompts">
          <div class="example-prompt" onclick="quickPrompt('Explain quantum computing in simple terms')">
            <div class="example-prompt-title">Explain quantum computing</div>
            <div class="example-prompt-desc">Simple explanation of quantum computing concepts</div>
          </div>
          <div class="example-prompt" onclick="quickPrompt('Write a Python function to calculate fibonacci sequence')">
            <div class="example-prompt-title">Python fibonacci function</div>
            <div class="example-prompt-desc">Generate code for fibonacci sequence calculation</div>
          </div>
          <div class="example-prompt" onclick="quickPrompt('Create a workout plan for beginners')">
            <div class="example-prompt-title">Beginner workout plan</div>
            <div class="example-prompt-desc">Design a weekly workout routine for beginners</div>
          </div>
          <div class="example-prompt" onclick="quickPrompt('Explain the theory of relativity')">
            <div class="example-prompt-title">Theory of relativity</div>
            <div class="example-prompt-desc">Explain Einstein's theory in simple terms</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Input Area -->
    <div class="input-area">
      <div class="input-container">
        <textarea class="input-field" id="messageInput" placeholder="Message AJ-GPT..." rows="1"></textarea>
        <div class="input-actions">
          <div class="input-action" title="Attach File">
            <i class="fas fa-paperclip"></i>
          </div>
          <div class="input-action" title="Voice Input">
            <i class="fas fa-microphone"></i>
          </div>
        </div>
        <button class="send-button" id="sendBtn">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Model Selector Modal (Now top right) -->
<div class="model-selector-modal" id="modelSelectorModal">
  <div class="model-modal-header">Select AI Model</div>
  <div class="model-modal-option active" data-model="grok" data-name="AJ-GPT-flash">
    <div class="model-modal-icon" style="background: var(--flash-color);">F</div>
    <div class="model-modal-info">
      <div class="model-modal-name">AJ-GPT-flash</div>
      <div class="model-modal-desc">Fast and efficient for most tasks</div>
      <div class="model-status">
        <span class="model-status-indicator" id="grok-status"></span>
        <span class="model-status-text" id="grok-status-text">Checking...</span>
      </div>
    </div>
  </div>
  <div class="model-modal-option" data-model="gemini" data-name="AJ-GPT-mini">
    <div class="model-modal-icon" style="background: var(--mini-color);">M</div>
    <div class="model-modal-info">
      <div class="model-modal-name">AJ-GPT-mini</div>
      <div class="model-modal-desc">Compact and resource-friendly</div>
      <div class="model-status">
        <span class="model-status-indicator" id="gemini-status"></span>
        <span class="model-status-text" id="gemini-status-text">Checking...</span>
      </div>
    </div>
  </div>
  <div class="model-modal-option" data-model="claude" data-name="AJ-GPT-claude">
    <div class="model-modal-icon" style="background: var(--claude-color);">C</div>
    <div class="model-modal-info">
      <div class="model-modal-name">AJ-GPT-claude</div>
      <div class="model-modal-desc">Best for reasoning and complex tasks</div>
      <div class="model-status">
        <span class="model-status-indicator" id="claude-status"></span>
        <span class="model-status-text" id="claude-status-text">Checking...</span>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="settings-modal" id="settingsModal">
  <div class="settings-content">
    <div class="settings-header">
      <div class="settings-title">Settings</div>
      <div class="settings-close" id="closeSettings">
        <i class="fas fa-times"></i>
      </div>
    </div>
    <div class="settings-body">
      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-item">
          <div class="settings-label">Dark Mode</div>
          <div class="settings-control">
            <div class="toggle-switch active" id="darkModeToggle">
              <div class="toggle-switch-handle"></div>
            </div>
          </div>
        </div>
        <div class="settings-item">
          <div class="settings-label">Premium White Mode</div>
          <div class="settings-control">
            <div class="toggle-switch" id="whiteModeToggle">
              <div class="toggle-switch-handle"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">General</div>
        <div class="settings-item">
          <div class="settings-label">Typing Animation</div>
          <div class="settings-control">
            <div class="toggle-switch active" id="typingToggle">
              <div class="toggle-switch-handle"></div>
            </div>
          </div>
        </div>
        <div class="settings-item">
          <div class="settings-label">Sound Effects</div>
          <div class="settings-control">
            <div class="toggle-switch" id="soundToggle">
              <div class="toggle-switch-handle"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Chat</div>
        <div class="settings-item">
          <div class="settings-label">Response Length</div>
          <div class="settings-control">
            <select class="settings-select" id="responseLength">
              <option value="short">Short</option>
              <option value="medium" selected>Medium</option>
              <option value="long">Long</option>
            </select>
          </div>
        </div>
        <div class="settings-item">
          <div class="settings-label">Font Size</div>
          <div class="settings-control">
            <select class="settings-select" id="fontSize">
              <option value="14px">Small</option>
              <option value="16px" selected>Medium</option>
              <option value="18px">Large</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="settings-footer">
      <button class="settings-button settings-button-secondary" id="resetSettings">Reset to Default</button>
      <button class="settings-button settings-button-primary" id="saveSettings">Save Settings</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <span id="toastMessage"></span>
</div>

<script>
// DOM Elements
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const newChatBtn = document.getElementById('newChatBtn');
const settingsBtn = document.getElementById('settingsBtn');
const chatContainer = document.getElementById('chatContainer');
const welcomeScreen = document.getElementById('welcomeScreen');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const modelSelectBtnInHeader = document.getElementById('modelSelectBtnInHeader'); 
const modelSelectorModal = document.getElementById('modelSelectorModal');
const searchInput = document.getElementById('searchInput');
const chatHistoryElement = document.getElementById('chatHistory');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toastMessage');
const clearChatBtn = document.getElementById('clearChatBtn');
const aiStatusIndicator = document.getElementById('aiStatusIndicator');
const aiStatusText = document.getElementById('aiStatusText');

// State Variables
let allChats = JSON.parse(localStorage.getItem('ajstudiozAllChats') || '[]');
let selectedChatId = null;
let darkMode = true;
let whiteMode = false;
let typingAnimationEnabled = true;
let soundEnabled = false;
let responseLength = 'medium';
let fontSize = '16px';
let selectedAI = 'grok';
let selectedAIName = 'AJ-GPT-flash';
let aiStatus = {
  grok: 'unknown',
  gemini: 'unknown',
  claude: 'unknown'
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  if (allChats.length === 0) {
    createNewChat();
  } else {
    selectedChatId = localStorage.getItem('ajstudiozLastChatId') || allChats[0].id;
    if (!allChats.some(chat => chat.id === selectedChatId)) {
        selectedChatId = allChats[0].id;
    }
  }
  renderChatHistory();
  renderMessages();
  setupEventListeners();
  
  // Check AI status on load
  checkAllAIStatus();
  
  // Set up periodic status checks
  setInterval(checkAllAIStatus, 60000); // Check every minute

  const currentChat = allChats.find(chat => chat.id === selectedChatId);
  if (currentChat) {
    selectedAI = currentChat.model;
    selectedAIName = currentChat.model === 'grok' ? 'AJ-GPT-flash' : 
                   currentChat.model === 'gemini' ? 'AJ-GPT-mini' : 'AJ-GPT-claude';
    
    document.querySelectorAll('.model-modal-option').forEach(option => {
      option.classList.toggle('active', option.dataset.model === currentChat.model);
    });
  }
  
  updateAIStatusDisplay();
});

// Helper to get the current chat object
function getCurrentChat() {
    return allChats.find(chat => chat.id === selectedChatId);
}

// Setup Event Listeners
function setupEventListeners() {
  mobileMenuBtn.addEventListener('click', () => {
    sidebar.classList.toggle('open');
    sidebarOverlay.classList.toggle('show');
  });
  
  sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('open');
    sidebarOverlay.classList.remove('show');
  });
  
  newChatBtn.addEventListener('click', createNewChat);
  
  settingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'flex';
  });
  
  closeSettings.addEventListener('click', () => {
    settingsModal.style.display = 'none';
  });
  
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  clearChatBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to clear this conversation?')) {
        const currentChat = getCurrentChat();
        if (currentChat) {
            currentChat.messages = [];
            saveAllChats();
            renderMessages();
            showToast('Conversation cleared', 'success');
        }
    }
  });
  
  modelSelectBtnInHeader.addEventListener('click', (event) => {
    event.stopPropagation();
    modelSelectorModal.style.display = modelSelectorModal.style.display === 'block' ? 'none' : 'block';
  });
  
  document.querySelectorAll('.model-modal-option').forEach(option => {
    option.addEventListener('click', () => {
      const modelIdentifier = option.dataset.model;
      const name = option.dataset.name;
      selectAI(modelIdentifier, name);
      modelSelectorModal.style.display = 'none';
    });
  });
  
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    filterChatHistory(searchTerm);
  });
  
  document.getElementById('darkModeToggle').addEventListener('click', () => {
    darkMode = !darkMode;
    document.getElementById('darkModeToggle').classList.toggle('active', darkMode);
    
    // If dark mode is enabled, disable white mode
    if (darkMode && whiteMode) {
      whiteMode = false;
      document.getElementById('whiteModeToggle').classList.remove('active');
    }
    
    applyTheme();
    saveSettings();
  });
  
  document.getElementById('whiteModeToggle').addEventListener('click', () => {
    whiteMode = !whiteMode;
    document.getElementById('whiteModeToggle').classList.toggle('active', whiteMode);
    
    // If white mode is enabled, disable dark mode
    if (whiteMode && darkMode) {
      darkMode = false;
      document.getElementById('darkModeToggle').classList.remove('active');
    }
    
    applyTheme();
    saveSettings();
  });
  
  document.getElementById('typingToggle').addEventListener('click', () => {
    typingAnimationEnabled = !typingAnimationEnabled;
    document.getElementById('typingToggle').classList.toggle('active', typingAnimationEnabled);
    saveSettings();
  });
  
  document.getElementById('soundToggle').addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
    saveSettings();
  });
  
  document.getElementById('saveSettings').addEventListener('click', () => {
    responseLength = document.getElementById('responseLength').value;
    fontSize = document.getElementById('fontSize').value;
    document.body.style.fontSize = fontSize;
    saveSettings();
    settingsModal.style.display = 'none';
    showToast('Settings saved successfully', 'success');
  });
  
  document.getElementById('resetSettings').addEventListener('click', () => {
    if (confirm('Reset all settings to default?')) {
      resetSettings();
      settingsModal.style.display = 'none';
      showToast('Settings reset to default', 'info');
    }
  });
  
  window.addEventListener('click', (event) => {
    if (event.target === settingsModal) {
      settingsModal.style.display = 'none';
    }
    if (!modelSelectBtnInHeader.contains(event.target) && !modelSelectorModal.contains(event.target)) {
      modelSelectorModal.style.display = 'none';
    }
  });
}

// Apply theme based on settings
function applyTheme() {
  if (whiteMode) {
    document.body.classList.add('light-theme');
  } else if (darkMode) {
    document.body.classList.remove('light-theme');
  } else {
    // Auto mode - follow system preference
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (prefersDark) {
      document.body.classList.remove('light-theme');
    } else {
      document.body.classList.add('light-theme');
    }
  }
}

// Check status of all AI models
async function checkAllAIStatus() {
  checkAIStatus('grok');
  checkAIStatus('gemini');
  checkAIStatus('claude');
}

// Check status of a specific AI model
async function checkAIStatus(aiModel) {
  try {
    // We'll make a simple request to the API to check if it's accessible
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        ai: aiModel,
        payload: {
          model: aiModel === 'grok' ? 'llama-3.1-70b-versatile' : 
                 aiModel === 'gemini' ? 'gemini-2.0-flash-exp' : 
                 'claude-sonnet-4-20250514',
          messages: [{ role: 'user', content: 'test' }],
          max_tokens: 1
        }
      })
    });
    
    if (response.ok) {
      aiStatus[aiModel] = 'online';
    } else {
      aiStatus[aiModel] = 'offline';
    }
  } catch (error) {
    aiStatus[aiModel] = 'offline';
  }
  
  updateAIStatusDisplay();
  updateModelStatusInModal(aiModel);
}

// Update AI status display in header
function updateAIStatusDisplay() {
  aiStatusText.textContent = selectedAIName;
  
  if (aiStatus[selectedAI] === 'online') {
    aiStatusIndicator.classList.remove('offline');
  } else {
    aiStatusIndicator.classList.add('offline');
  }
}

// Update AI status in model selector modal
function updateModelStatusInModal(aiModel) {
  const statusIndicator = document.getElementById(`${aiModel}-status`);
  const statusText = document.getElementById(`${aiModel}-status-text`);
  
  if (statusIndicator && statusText) {
    if (aiStatus[aiModel] === 'online') {
      statusIndicator.classList.remove('offline');
      statusText.textContent = 'Online';
    } else {
      statusIndicator.classList.add('offline');
      statusText.textContent = 'Offline';
    }
  }
}

// Load Settings
function loadSettings() {
  const settings = JSON.parse(localStorage.getItem('ajstudiozSettings') || '{}');
  
  if (settings.darkMode !== undefined) {
    darkMode = settings.darkMode;
    document.getElementById('darkModeToggle').classList.toggle('active', darkMode);
  }
  
  if (settings.whiteMode !== undefined) {
    whiteMode = settings.whiteMode;
    document.getElementById('whiteModeToggle').classList.toggle('active', whiteMode);
  }
  
  if (settings.typingAnimationEnabled !== undefined) {
    typingAnimationEnabled = settings.typingAnimationEnabled;
    document.getElementById('typingToggle').classList.toggle('active', typingAnimationEnabled);
  }
  
  if (settings.soundEnabled !== undefined) {
    soundEnabled = settings.soundEnabled;
    document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
  }
  
  if (settings.responseLength) {
    responseLength = settings.responseLength;
    document.getElementById('responseLength').value = responseLength;
  }
  
  if (settings.fontSize) {
    fontSize = settings.fontSize;
    document.body.style.fontSize = fontSize;
    document.getElementById('fontSize').value = fontSize;
  }
  
  applyTheme();
}

// Save Settings
function saveSettings() {
  const settings = {
    darkMode,
    whiteMode,
    typingAnimationEnabled,
    soundEnabled,
    responseLength,
    fontSize
  };
  localStorage.setItem('ajstudiozSettings', JSON.stringify(settings));
}

// Reset Settings
function resetSettings() {
  darkMode = true;
  whiteMode = false;
  typingAnimationEnabled = true;
  soundEnabled = false;
  responseLength = 'medium';
  fontSize = '16px';
  
  document.getElementById('darkModeToggle').classList.add('active');
  document.getElementById('whiteModeToggle').classList.remove('active');
  document.getElementById('typingToggle').classList.add('active');
  document.getElementById('soundToggle').classList.remove('active');
  
  document.getElementById('responseLength').value = responseLength;
  document.getElementById('fontSize').value = fontSize;
  
  document.body.style.fontSize = fontSize;
  applyTheme();
  
  saveSettings();
}

// Save all chats to local storage
function saveAllChats() {
    localStorage.setItem('ajstudiozAllChats', JSON.stringify(allChats));
    if (selectedChatId) {
        localStorage.setItem('ajstudiozLastChatId', selectedChatId);
    }
}

// Create a new chat conversation
function createNewChat() {
    if (selectedChatId) {
        saveAllChats(); 
    }

    const newChat = {
        id: crypto.randomUUID(),
        title: "New Conversation",
        date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        model: selectedAI,
        messages: []
    };
    allChats.unshift(newChat);
    selectedChatId = newChat.id;
    saveAllChats();
    renderChatHistory();
    renderMessages();
    showToast('New conversation started', 'success');
}

// Switch to a different chat
function switchChat(chatId) {
    if (selectedChatId === chatId) return;

    saveAllChats();

    selectedChatId = chatId;
    localStorage.setItem('ajstudiozLastChatId', selectedChatId);
    renderChatHistory();
    renderMessages();

    const currentChat = getCurrentChat();
    if (currentChat) {
        selectedAI = currentChat.model;
        selectedAIName = currentChat.model === 'grok' ? 'AJ-GPT-flash' : 
                       currentChat.model === 'gemini' ? 'AJ-GPT-mini' : 'AJ-GPT-claude';
        
        document.querySelectorAll('.model-modal-option').forEach(option => {
            option.classList.toggle('active', option.dataset.model === currentChat.model);
        });
        
        updateAIStatusDisplay();
    }
    showToast(`Switched to: ${currentChat.title}`, 'info');
}

// Select AI (model for the current chat)
function selectAI(aiIdentifier, name) {
  const currentChat = getCurrentChat();
  if (currentChat) {
    currentChat.model = aiIdentifier;
    selectedAI = aiIdentifier;
    selectedAIName = name; 
    saveAllChats();
  } else {
    selectedAI = aiIdentifier; 
    selectedAIName = name;
  }

  document.querySelectorAll('.model-modal-option').forEach(option => {
    option.classList.toggle('active', option.dataset.model === aiIdentifier);
  });
  
  updateAIStatusDisplay();
  showToast(`Selected AI for this chat: ${name}`, 'info');
}

// Show Toast Notification
function showToast(message, type = 'info') {
  toastMessage.textContent = message;
  toast.className = 'toast show ' + type;
  
  if (soundEnabled) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.value = type === 'error' ? 300 : 600;
    gainNode.gain.value = 0.1;
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  }
  
  setTimeout(() => {
    toast.className = 'toast';
  }, 3000);
}

// Format Timestamp
function formatTimestamp() {
  const now = new Date();
  return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Render Chat History
function renderChatHistory() {
  chatHistoryElement.innerHTML = '';
  
  allChats.forEach(chat => {
    const item = document.createElement('div');
    item.classList.add('chat-history-item');
    if (chat.id === selectedChatId) {
      item.classList.add('active');
    }
    item.dataset.chatId = chat.id;
    item.innerHTML = `
      <div class="chat-history-title">${chat.title}</div>
      <div class="chat-history-date">${chat.date}</div>
    `;
    item.addEventListener('click', () => switchChat(chat.id));
    chatHistoryElement.appendChild(item);
  });
}

// Filter Chat History
function filterChatHistory(searchTerm) {
  const items = chatHistoryElement.querySelectorAll('.chat-history-item');
  
  items.forEach(item => {
    const title = item.querySelector('.chat-history-title').textContent.toLowerCase();
    if (title.includes(searchTerm)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

// Render Messages for the selected chat
function renderMessages() {
  const currentChat = getCurrentChat();

  if (!currentChat || currentChat.messages.length === 0) {
    welcomeScreen.style.display = 'block';
    chatContainer.innerHTML = '';
    chatContainer.appendChild(welcomeScreen);
    return;
  }
  
  welcomeScreen.style.display = 'none';
  
  let existingWelcomeScreen = chatContainer.querySelector('.welcome-screen');
  chatContainer.innerHTML = '';
  if (existingWelcomeScreen) {
      chatContainer.appendChild(existingWelcomeScreen);
  }

  currentChat.messages.forEach((msg, index) => {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', msg.sender);
    if (msg.sender === 'ai') messageDiv.classList.add(msg.aiType); 
    
    const avatar = document.createElement('div');
    avatar.classList.add('message-avatar');
    avatar.textContent = msg.sender === 'user' ? 'U' : 
                         msg.aiType === 'grok' ? 'F' : 
                         msg.aiType === 'gemini' ? 'M' : 'C';
    messageDiv.appendChild(avatar);
    
    const content = document.createElement('div');
    content.classList.add('message-content');
    
    const text = document.createElement('div');
    text.classList.add('message-text');
    
    const processedText = processMessageText(msg.text);
    text.innerHTML = processedText;
    content.appendChild(text);
    
    if (msg.sender === 'ai') {
      const actions = document.createElement('div');
      actions.classList.add('message-actions');
      
      const copyAction = document.createElement('div');
      copyAction.classList.add('message-action');
      copyAction.innerHTML = '<i class="fas fa-copy"></i> Copy';
      copyAction.onclick = () => {
        navigator.clipboard.writeText(msg.text);
        showToast('Message copied to clipboard', 'success');
      };
      actions.appendChild(copyAction);
      
      const regenerateAction = document.createElement('div');
      regenerateAction.classList.add('message-action');
      regenerateAction.innerHTML = '<i class="fas fa-redo"></i> Regenerate';
      regenerateAction.onclick = () => {
        regenerateResponse(index);
      };
      actions.appendChild(regenerateAction);
      
      content.appendChild(actions);
    }
    
    messageDiv.appendChild(content);
    chatContainer.appendChild(messageDiv);
  });
  
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Process Message Text to Handle Code Blocks - ENHANCED VERSION
function processMessageText(text) {
  let processedText = text;
  
  // First handle code blocks with language specification
  processedText = processedText.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, language, code) => {
    const lang = language || 'text';
    const trimmedCode = code.trim();
    const isHtml = lang === 'html';
    
    // Check if code is large (over 50 lines)
    const lineCount = trimmedCode.split('\n').length;
    const isLargeCode = lineCount > 50;
    
    return `
      <div class="code-block ${isLargeCode ? 'large-code' : ''}">
        <div class="code-header">
          <div class="code-language">${lang} ${isLargeCode ? `(${lineCount} lines)` : ''}</div>
          <button class="copy-code-btn" onclick="copyCode(this)">
            <i class="fas fa-copy"></i> Copy
          </button>
          ${isHtml ? `
          <button class="preview-code-btn" onclick="togglePreview(this)">
            <i class="fas fa-eye"></i> Preview
          </button>
          ` : ''}
        </div>
        <div class="code-content">
          <pre><code class="language-${lang}">${escapeHtml(trimmedCode)}</code></pre>
        </div>
        ${isHtml ? `
        <div class="preview-container">
          <div class="preview-header">
            <span>Preview</span>
            <button class="preview-close" onclick="closePreview(this)">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="preview-content"></div>
        </div>
        ` : ''}
      </div>
    `;
  });
  
  // Handle inline code (backticks) - but avoid double processing
  processedText = processedText.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  
  // Handle other markdown formatting
  processedText = processedText
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
  
  return processedText;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Copy Code - ENHANCED VERSION
function copyCode(button) {
  const codeBlock = button.closest('.code-block');
  const codeContent = codeBlock.querySelector('code').textContent;
  
  // Check if it's a large code block
  const isLargeCode = codeBlock.classList.contains('large-code');
  
  navigator.clipboard.writeText(codeContent).then(() => {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    
    setTimeout(() => {
      button.innerHTML = originalHTML;
    }, 2000);
    
    showToast(isLargeCode ? 'Large code copied to clipboard' : 'Code copied to clipboard', 'success');
  }).catch(err => {
    console.error('Failed to copy code:', err);
    showToast('Failed to copy code', 'error');
  });
}

// Toggle Code Preview - ENHANCED VERSION
function togglePreview(button) {
  const codeBlock = button.closest('.code-block');
  const previewContainer = codeBlock.querySelector('.preview-container');
  const previewContent = previewContainer.querySelector('.preview-content');
  const codeContent = codeBlock.querySelector('code').textContent;
  
  if (previewContainer.style.display === 'none' || !previewContainer.style.display) {
    // Show preview
    previewContainer.style.display = 'block';
    
    // Clear preview content
    previewContent.innerHTML = '';
    
    // Create iframe to safely render HTML
    const iframe = document.createElement('iframe');
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.backgroundColor = 'white';
    
    previewContent.appendChild(iframe);
    
    // Write HTML content to iframe
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    iframeDoc.open();
    iframeDoc.write(codeContent);
    iframeDoc.close();
    
    button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
  } else {
    // Hide preview
    previewContainer.style.display = 'none';
    button.innerHTML = '<i class="fas fa-eye"></i> Preview';
  }
}

// Close Preview
function closePreview(button) {
  const previewContainer = button.closest('.preview-container');
  const codeBlock = button.closest('.code-block');
  const previewButton = codeBlock.querySelector('.preview-code-btn');
  
  previewContainer.style.display = 'none';
  previewButton.innerHTML = '<i class="fas fa-eye"></i> Preview';
}

// Create Typing Indicator
function createTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.classList.add('typing-indicator');
  
  const currentAIName = selectedAIName || 'AI';

  const typingText = document.createElement('span');
  typingText.textContent = currentAIName + ' is typing';
  typingDiv.appendChild(typingText);
  
  const typingDots = document.createElement('div');
  typingDots.classList.add('typing-dots');
  
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement('div');
    dot.classList.add('typing-dot');
    typingDots.appendChild(dot);
  }
  
  typingDiv.appendChild(typingDots);
  chatContainer.appendChild(typingDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  
  return typingDiv;
}

// Quick Prompt
function quickPrompt(text) {
  messageInput.value = text;
  messageInput.focus();
  sendMessage();
}

// Send Message - ENHANCED VERSION
async function sendMessage() {
  const message = messageInput.value.trim();
  if (!message) return;
  
  const currentChat = getCurrentChat();
  if (!currentChat) {
      showToast('No active chat. Please start a new conversation.', 'error');
      return;
  }

  // Update chat title if it's "New Conversation" and this is the first message
  if (currentChat.messages.length === 0 && currentChat.title === "New Conversation") {
      currentChat.title = message.substring(0, 30) + (message.length > 30 ? "..." : "");
      renderChatHistory();
  }

  // Add user message to current chat
  currentChat.messages.push({
    sender: 'user',
    text: message,
    timestamp: formatTimestamp()
  });
  
  saveAllChats();
  renderMessages();
  
  messageInput.value = '';
  sendBtn.disabled = true;
  
  // Show typing indicator
  const typingIndicator = createTypingIndicator();
  
  try {
    let backendAIIdentifier = ''; 
    let modelNameForPayload = '';

    if (currentChat.model === 'grok') {
      backendAIIdentifier = 'grok';
      modelNameForPayload = 'llama-3.1-70b-versatile'; 
    } else if (currentChat.model === 'gemini') {
      backendAIIdentifier = 'gemini';
      modelNameForPayload = 'gemini-2.0-flash-exp'; 
    } else if (currentChat.model === 'claude') {
      backendAIIdentifier = 'claude';
      modelNameForPayload = 'claude-sonnet-4-20250514';
    } else {
      console.error("Unknown AI selected in current chat:", currentChat.model);
      showToast('Error: Unknown AI model selected for this chat.', 'error');
      sendBtn.disabled = false;
      typingIndicator.remove();
      return;
    }
    
    // Build conversation history for better context
    const conversationHistory = currentChat.messages.slice(-6).map(msg => ({
      role: msg.sender === 'user' ? 'user' : 'assistant',
      content: msg.text
    }));
    
    const body = {
      model: modelNameForPayload,
      messages: conversationHistory,
      temperature: 0.7,
      max_tokens: 2048
    };
    
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        ai: backendAIIdentifier, 
        payload: body
      })
    });
    
    typingIndicator.remove();
    
    if (!response.ok) {
      let errorDetails = `API error ${response.status}`;
      try {
        const errorData = await response.json();
        if (errorData.error && typeof errorData.error === 'object' && errorData.error.message) {
            errorDetails += `: ${errorData.error.message}`;
        } else if (errorData.error) {
            errorDetails += `: ${errorData.error}`;
        } else if (errorData.details) {
            errorDetails += `: ${errorData.details}`;
        } else {
            errorDetails += `: ${JSON.stringify(errorData)}`;
        }
      } catch (jsonError) {
        errorDetails += `: ${await response.text()}`; 
      }
      throw new Error(errorDetails);
    }
    
    const data = await response.json();
    
    let aiText = data.choices?.[0]?.message?.content || 'No response';
    
    currentChat.messages.push({
      sender: 'ai',
      text: aiText,
      timestamp: formatTimestamp(),
      aiType: currentChat.model 
    });
    
    saveAllChats();
    
    if (typingAnimationEnabled) {
      renderTypingMessage(currentChat.messages[currentChat.messages.length - 1]);
    } else {
      renderMessages();
    }
    
  } catch (err) {
    typingIndicator.remove();
    console.error("Frontend error during API call:", err);
    const displayErrorMessage = err.message.length > 100 ? err.message.substring(0, 97) + '...' : err.message;
    showToast('Error: ' + displayErrorMessage, 'error');
    
    currentChat.messages.push({
      sender: 'ai',
      text: `Sorry, I encountered an error while processing your request. Please try again later. Details: ${displayErrorMessage}`,
      timestamp: formatTimestamp(),
      aiType: currentChat.model 
    });
    
    saveAllChats();
    renderMessages();
  } finally {
    sendBtn.disabled = false;
    messageInput.focus();
  }
}

// Render Typing Message
async function renderTypingMessage(aiMessage) {
  const existingTypingIndicator = chatContainer.querySelector('.typing-indicator');
  if (existingTypingIndicator) existingTypingIndicator.remove();

  const messageDiv = document.createElement('div');
  messageDiv.classList.add('message', 'ai', aiMessage.aiType);
  
  const avatar = document.createElement('div');
  avatar.classList.add('message-avatar');
  avatar.textContent = aiMessage.aiType === 'grok' ? 'F' : 
                      aiMessage.aiType === 'gemini' ? 'M' : 'C';
  messageDiv.appendChild(avatar);
  
  const content = document.createElement('div');
  content.classList.add('message-content');
  
  const text = document.createElement('div');
  text.classList.add('message-text');
  content.appendChild(text);
  
  const actions = document.createElement('div');
  actions.classList.add('message-actions');
  
  const copyAction = document.createElement('div');
  copyAction.classList.add('message-action');
  copyAction.innerHTML = '<i class="fas fa-copy"></i> Copy';
  copyAction.onclick = () => {
    navigator.clipboard.writeText(aiMessage.text);
    showToast('Message copied to clipboard', 'success');
  };
  actions.appendChild(copyAction);
  
  const regenerateAction = document.createElement('div');
  regenerateAction.classList.add('message-action');
  regenerateAction.innerHTML = '<i class="fas fa-redo"></i> Regenerate';
  regenerateAction.onclick = () => {
    regenerateResponse(getCurrentChat().messages.indexOf(aiMessage));
  };
  actions.appendChild(regenerateAction);
  
  content.appendChild(actions);
  messageDiv.appendChild(content);
  chatContainer.appendChild(messageDiv);
  
  let displayedText = '';
  const words = aiMessage.text.split(' ');
  
  for (let i = 0; i < words.length; i++) {
    displayedText += (i > 0 ? ' ' : '') + words[i];
    
    const processedText = processMessageText(displayedText);
    text.innerHTML = processedText;
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    const delay = Math.min(50, Math.max(10, 100 - words[i].length * 2));
    await new Promise(resolve => setTimeout(resolve, delay));
  }
}

// Regenerate Response
async function regenerateResponse(messageIndex) {
  const currentChat = getCurrentChat();
  if (!currentChat || messageIndex <= 0 || currentChat.messages[messageIndex].sender !== 'ai') return;
  
  const userMessageIndex = messageIndex - 1;
  if (userMessageIndex < 0 || currentChat.messages[userMessageIndex].sender !== 'user') return;
  
  const userMessage = currentChat.messages[userMessageIndex].text;
  
  // Remove the AI response and all subsequent messages
  currentChat.messages = currentChat.messages.slice(0, messageIndex);
  saveAllChats();
  renderMessages();
  
  messageInput.value = userMessage;
  sendMessage();
}
</script>
</body> 
</html>
